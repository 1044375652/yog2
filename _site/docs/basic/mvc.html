<!DOCTYPE html>
<html>
    <!--head-->
    <head>
      <!-- page title goes here -->
<title>YOG2 - 工业级 Node.js UI 层解决方案</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<!-- add your name or URL here -->
<meta name="author" content="fex@baidu.com">
<!-- add a description of your site/company/product here -->
<meta name="description" content="YOG2 - 工业级 Node.js UI 层解决方案">
<!-- add the keywords here that represent your site, an example few have been added -->
<meta name="keywords" content="node, nodejs, fis, fex">
<!-- add your name or URL here -->
<meta name="publisher" content="fex">
<meta name="rating" content="General">
<!-- Bootstrap -->
<link href="/yog2/css/bootstrap.css" rel="stylesheet" media="screen">
<!-- Theme styles -->
<link href="/yog2/css/styles.css" rel="stylesheet" media="screen">
<link href="/yog2/css/animate.min.css" rel="stylesheet" media="screen">
<link href="/yog2/css/font-awesome.min.css" rel="stylesheet" media="screen">
<!-- media-queries -->
<link href="/yog2/css/media-queries.css" rel="stylesheet" media="screen">
<!-- modernizr -->
<script src="/yog2/js/modernizr.custom.js"></script>
<script src="/yog2/js/wow.min.js"></script>

      <link rel="stylesheet" href="/yog2/css/github.css">
    </head>
    <!--head-->
  <body>
    <nav class="navbar" role="navigation">
    <!-- container -->
<div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">YOG2</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse  navbar-collapse  navbar-ex1-collapse">
        <ul class="nav  navbar-nav">
            <li><a href="/yog2/">首页</a></li>
            <li><a href="/yog2/docs">文档</a></li>
            <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
            <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
            <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
        </ul>
    </div>
    <!-- /navbar-collapse -->
</div>
<!-- /container -->

    </nav>
    <div class="doc-wrap">
    <nav class="sidebar" data-spy="affix" data-offset-top="95">
    <ul>
        
        <li class="item-category">
            
            <a href="/yog2/docs/">
                快速入门
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                基础使用
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/cli.html#命令行">
                命令行
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/structure.html#目录结构">
                目录结构
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/router.html#路由">
                路由
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/mvc.html#mvc">
                MVC
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                插件系统
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件系统">
                内置插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#用户插件">
                用户插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件配置">
                插件配置
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                内置功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/middleware.html#中间件管理">
                中间件管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/log.html#日志管理">
                日志管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/service.html#服务管理">
                服务管理
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                前端工程化
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端工程化">
                目录规范
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#三种语言能力">
                三种语言能力
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端模块化">
                前端模块化
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/backend-template.html#后端模板">
                后端模板
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/optimizer.html#性能优化">
                性能优化
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                进阶功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#BigPipe">
                BigPipe
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#Quickling">
                Quickling
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                其他
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/reference.html#参考资料">
                参考资料
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/FAQ.html#faq">
                FAQ
            </a>
            
        </li>
        
    </ul>
</nav>
<div class="bottom-shadow"></div>

    <div class="doc-container">
      <div class="toc" data-spy="affix" data-offset-top="95"></div>
      <article class="doc-content codehilite">
      <h2 id="mvc">MVC</h2>

<h3 id="控制器">控制器</h3>

<p>控制器是 Web 服务实际业务逻辑的载体，路由系统会将请求根据路由规则分发到控制器，由控制器去解析请求参数、访问数据服务以及返回结果。在 yog2 中，控制器就是路由系统指向的 <code>action</code> 文件。</p>

<p>以一个简单的用户创建与获取的 API 为例简单说明一下用法</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">userModel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel.js&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invalid id&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">userModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">post</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gender</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">gender</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;invalid name&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">userModel</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
        <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">gender</span><span class="o">:</span> <span class="nx">gender</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>可以看出控制器中的函数实际上就是 express 在路由注册时的回调函数，因此其中的参数 <code>req</code> <code>res</code> <code>next</code> 均可以参考  <a href="http://expressjs.com/4x/api.html">express文档</a> 使用。</p>

<h3 id="数据模型">数据模型</h3>

<p>由于 yog2 的核心目标是更好的提供 UI中间层 支持，因此并未内置任何数据库 ORM 功能。当然，通过中间件和插件扩展，我们也可以很轻松的引入类似 <a href="https://github.com/balderdashy/waterline">waterline</a> 和 <a href="https://github.com/Automattic/mongoose">mongoose</a> 这类 ORM 库用于数据库的访问。</p>

<p>虽然没有内置 ORM 功能，但是我们提供了一套后端服务管理工具用于 UI中间层对后端服务层的请求管理。</p>

<p>数据模型又可以分为服务层和数据层，服务层可以专注与业务逻辑封装和数据层的调用，数据层则专注于与后端服务层的交互。当然在业务不复杂的时候，我们也可以直接将服务层与数据层融合。</p>

<p>以控制器中的 userModel 为例，我们可以实现一个简单的数据模型。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// /server/models/userModel.js</span>

<span class="kd">var</span> <span class="nx">yog</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yog2-kernel&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="kr">export</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">yog</span><span class="p">.</span><span class="nx">ral</span><span class="p">(</span><span class="s1">&#39;BACKEND&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/api/user&#39;</span><span class="p">,</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="kr">export</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">yog</span><span class="p">.</span><span class="nx">ral</span><span class="p">(</span><span class="s1">&#39;BACKEND&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/api/user&#39;</span><span class="p">,</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">pack</span><span class="o">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">user</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
<p>其中 <code>yog.ral</code> 是 yog2 框架的后端服务管理工具，使用之前需要在 project 中进行一些简单的配置。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// /conf/ral/backend.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">BACKEND</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
        <span class="nx">pack</span><span class="o">:</span> <span class="s1">&#39;querystring&#39;</span><span class="p">,</span>
        <span class="nx">unpack</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
        <span class="nx">balance</span><span class="o">:</span> <span class="s1">&#39;roundrobin&#39;</span><span class="p">,</span>
        <span class="nx">server</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;backend.server&#39;</span><span class="p">,</span> 
                <span class="nx">port</span><span class="o">:</span> <span class="mi">80</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>要如示例中Promise的形式使用 yog.ral ，需要安装插件 <a href="https://github.com/hefangshi/yog2-plugin-ral-promise">yog2-plugin-ral-promise</a></p>
</blockquote>

<h3 id="模板引擎">模板引擎</h3>

<p>yog2 默认使用了 <a href="https://github.com/paularmstrong/swig">swig</a> 作为模板引擎。同时我们扩展了模版引擎使其能够支持更多的功能，其中最核心的功能就是 FIS 的后端静态资源管理能力，这个功能将会在 <a href="#%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96">前端工程化</a> 一节详细描述，在此我们会介绍一下如何在 yog2 中使用模板引擎。</p>

<p>在 yog2 中，我们一般会将模板根据使用类别的不同，分别将页面类型的后端模板放至于 app 的 <code>/client/page</code> 目录中，而将组件类型的后端模板放至于app 的  <code>/client/widget/WIDGET_NAME</code> 目录中。</p>

<p>以 <code>yog2 init app</code> 生成的默认 DEMO 为例</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">├── client
│   ├── page
│   │   ├── index.tpl
│   │   └── layout.tpl
│   └── widget
│       └── message
│           └── message.tpl
├── fis-conf.js
</code></pre></div>
<p>我们可以看到其中拥有三个 <code>tpl</code> ，即后端模板文件，其中 <code>layout.tpl</code> 是页面的母版页，其中可以实现一些页面间共用的部分，而 <code>index.tpl</code> 则是我们首页的后端模板。<code>message.tpl</code> 则是供各个页面引用的后端模板组件。</p>

<p>当拥有了模板后，我们还有一个工作就是将数据传递给模板，并将渲染结果返回前端。这类操作如前文所说，应该在控制器也就是 action 中完成。还是以前文中的 userModel 为例，我们将用户信息不以 JSON 的形式，而是以页面的形式展现出来。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">var userModel = require(&#39;../models/userModel.js&#39;);

module.exports.get = function (req, res, next) {
    var id = parseInt(req.body.id, 10);
    if (isNaN(id)) {
        throw new Error(&#39;invalid id&#39;);
    }
    userModel.get(id)
    .then(function (user) {
        res.render(&#39;home/page/index.tpl&#39;, {
            user: user
        });
    })
    .catch(next);
}
</code></pre></div>
<p>通过 <code>res.render</code> 函数，我们就可以将数据注入至模板进行渲染并返回了。值得注意的是，在模板路径的书写上，我们需要按照 <code>APP_NAME/page/PAGE.tpl</code> 的格式书写。</p>

      <blockquote>
        <p>文章有错误？直接提交修改 <a target="_blank" href="https://github.com/fex-team/yog2/edit/gh-pages/docs/basic/mvc.md">docs/basic/mvc.md</a></p>
      </blockquote>
      </article>
      <!-- footer -->
<section class="footer  flush--top">
    <div class="container">
        <div class="row">
            <ul class="list-unstyled  col-12  col-sm-3  col-lg-2">
                <li><a href="oak@baidu.com">Email</a></li>
                <li><a href="https://github.com/fex-team/yog2/issues" target="_blank">Github Issue</a></li>
            </ul>
            <ul class="list-unstyled  col-12  col-sm-2  col-lg-2">
                <li><a href="/yog2/">首页</a></li>
                <li><a href="/yog2/docs">文档</a></li>
                <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
                <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
                <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
            </ul>
            <div class="col-12  col-sm-7  col-lg-5  col-lg-offset-3  text-left  hard--left">
                <h3 class="footer--main-logo">加入我们</h3> FEX 是百度「Web 前端研发部」的内部名称
                <br/> 其中 FE 是 Front End 的缩写，X 代表我们不仅关注前端技术，还更重视全端及全栈的能力。
                <br/> 如果你对这个团队感兴趣，可以 <a class="underline" target="_blank" href="http://fex.baidu.com/we-need-you/">点击这里</a>。
            </div>
        </div>
    </div>
</section>
<!-- footer -->

    </div>
    </div>

    <!-- jQuery -->
    <script src="/yog2/js/jquery.js"></script>
    <script src="/yog2/js/scrollspy.js"></script>
    <script src="/yog2/js/toc.js"></script>
    <!-- Bootstrap js -->
    <script src="/yog2/js/bootstrap.min.js"></script>
    <!-- Optionally enable responsive features in IE8. Respond.js can be obtained from https://github.com/scottjehl/Respond -->
    <script src="/yog2/js/respond.min.js"></script>

  </body>

</html>
