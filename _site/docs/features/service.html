<!DOCTYPE html>
<html>
    <!--head-->
    <head>
      <!-- page title goes here -->
<title>YOG2 - 工业级 Node.js UI 层解决方案</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<!-- add your name or URL here -->
<meta name="author" content="fex@baidu.com">
<!-- add a description of your site/company/product here -->
<meta name="description" content="YOG2 - 工业级 Node.js UI 层解决方案">
<!-- add the keywords here that represent your site, an example few have been added -->
<meta name="keywords" content="node, nodejs, fis, fex">
<!-- add your name or URL here -->
<meta name="publisher" content="fex">
<meta name="rating" content="General">
<!-- Bootstrap -->
<link href="/yog2/css/bootstrap.css" rel="stylesheet" media="screen">
<!-- Theme styles -->
<link href="/yog2/css/styles.css" rel="stylesheet" media="screen">
<link href="/yog2/css/animate.min.css" rel="stylesheet" media="screen">
<link href="/yog2/css/font-awesome.min.css" rel="stylesheet" media="screen">
<!-- media-queries -->
<link href="/yog2/css/media-queries.css" rel="stylesheet" media="screen">
<!-- modernizr -->
<script src="/yog2/js/modernizr.custom.js"></script>
<script src="/yog2/js/wow.min.js"></script>

      <link rel="stylesheet" href="/yog2/css/github.css">
    </head>
    <!--head-->
  <body>
    <nav class="navbar" role="navigation">
    <!-- container -->
<div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">YOG2</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse  navbar-collapse  navbar-ex1-collapse">
        <ul class="nav  navbar-nav">
            <li><a href="/yog2/">首页</a></li>
            <li><a href="/yog2/docs">文档</a></li>
            <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
            <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
            <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
        </ul>
    </div>
    <!-- /navbar-collapse -->
</div>
<!-- /container -->

    </nav>
    <div class="doc-wrap">
    <nav class="sidebar" data-spy="affix" data-offset-top="95">
    <ul>
        
        <li class="item-category">
            
            <a href="/yog2/docs/">
                快速入门
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                基础使用
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/cli.html#命令行">
                命令行
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/structure.html#目录结构">
                目录结构
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/router.html#路由">
                路由
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/mvc.html#mvc">
                MVC
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                插件系统
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件系统">
                内置插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#用户插件">
                用户插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件配置">
                插件配置
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                内置功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/middleware.html#中间件管理">
                中间件管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/log.html#日志管理">
                日志管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/service.html#服务管理">
                服务管理
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                前端工程化
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端工程化">
                目录规范
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#三种语言能力">
                三种语言能力
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端模块化">
                前端模块化
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/backend-template.html#后端模板">
                后端模板
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/optimizer.html#性能优化">
                性能优化
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                进阶功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#BigPipe">
                BigPipe
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#Quickling">
                Quickling
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                其他
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/reference.html#参考资料">
                参考资料
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/FAQ.html#faq">
                FAQ
            </a>
            
        </li>
        
    </ul>
</nav>
<div class="bottom-shadow"></div>

    <div class="doc-container">
      <div class="toc" data-spy="affix" data-offset-top="95"></div>
      <article class="doc-content codehilite">
      <h2 id="服务管理">服务管理</h2>

<p>yog2 中，使用 <a href="https://github.com/fex-team/node-ral">node-ral</a> 进行后端服务管理，我们引入后端服务管理层主要是解决以下几个问题</p>

<ul>
<li>后端服务配置统一管理</li>
<li>封装异常处理、超时重试，提升系统稳定性</li>
<li>封装日志，便于线上问题追查</li>
<li>抽象请求协议、数据格式与数据编码，统一用户接口</li>
</ul>

<p>在后端服务配置统一管理方面，我们的准则是配置优于硬编码，虽然使用类似 <a href="https://github.com/request/request">request</a> 一类的库也可以很好的实现 HTTP 请求服务，但是它并没有明确的控制诸如服务请求地址等等参数的设置，进而容易导致在项目中出现后端配置分散、开发配置与线上配置管理混乱的问题。</p>

<p>在封装异常、超时重试方面，我们抽象了服务请求模型，使得各种数据格式与请求协议之间的异常封装和超时重试逻辑可以通用。当引入了一种的服务类型后，这类逻辑不需要重新实现。并且由于异常处理已经覆盖了整个服务请求的各个阶段，不会出现类似 <code>JSON.parse</code> 忘记添加异常处理导致的 Node 服务 Crash 的问题。</p>

<p>除了通用的异常和超时重试逻辑外，<a href="https://github.com/fex-team/node-ral">node-ral</a> 还提供了请求日志功能，无需做任何额外的编码工作就可以详尽的查看到请求的各个过程的信息，以及请求耗时的统计信息等等，方便线上问题的追查。</p>

<p><a href="https://github.com/fex-team/node-ral">node-ral</a> 最大的特色之一就是解耦了请求协议和数据格式，实现了接口正交化。解耦的优势在于我们可以任意的组合数据格式与请求协议，比如当请求协议不是 HTTP 协议而是 Socket 协议时，我们依然可以沿用目前的 <code>JSON</code>、<code>Form</code> 甚至 <code>Stream</code> 的数据打包格式，而用户在调整请求协议与数据格式时只需要调整一个参数，在调用服务时只需要提供请求参数和数据，请求协议与数据格式可以对开发人员完全透明。</p>

<p>综上所述，我们可以看到 <a href="https://github.com/fex-team/node-ral">node-ral</a>  是 Node.js UI 中间层能够稳定健壮运行的核心组件之一。</p>

<h3 id="服务配置">服务配置</h3>

<p>在 yog2 下所有的 <code>ral</code> 配置均放在 project 目录下的 <code>/conf/ral</code> 中。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="c1">// conf/ral/API.js </span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">MAPAPI</span><span class="o">=</span> <span class="p">{</span>           <span class="c1">// 声明服务名为MAPAPI</span>
    <span class="c1">// 请求协议与数据格式配置</span>
    <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>              <span class="c1">// 使用http协议请求</span>
    <span class="nx">pack</span><span class="o">:</span> <span class="s1">&#39;querystring&#39;</span><span class="p">,</span>           <span class="c1">// 数据封装为query</span>
    <span class="nx">unpack</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>                <span class="c1">// 约定服务端返回JSON数据</span>
    <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>             <span class="c1">// 服务器返回utf-8编码</span>
    <span class="c1">// 负载均衡与超时重试配置</span>
    <span class="nx">balance</span><span class="o">:</span> <span class="s1">&#39;roundrobin&#39;</span><span class="p">,</span>         <span class="c1">// 负载均衡策略</span>
    <span class="nx">timeout</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>                  <span class="c1">// 请求最长超时时间500ms</span>
    <span class="nx">retry</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>                      <span class="c1">// 请求重试次数</span>
    <span class="c1">// HTTP协议特有配置</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>                 <span class="c1">// 使用GET请求</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>                       <span class="c1">// 服务的全局query</span>
        <span class="nx">ak</span><span class="o">:</span> <span class="s1">&#39;0C62f9f0ee027b6052dfa35b0f38b61a&#39;</span><span class="p">,</span>
        <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="nx">page_size</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nx">page_num</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">scope</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/place/v2/search&#39;</span><span class="p">,</span>      <span class="c1">// API路径</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>                     <span class="c1">// 服务的全局headers</span>
        <span class="s1">&#39;x-client&#39;</span><span class="o">:</span> <span class="s1">&#39;ral&#39;</span>
    <span class="p">},</span>
    <span class="c1">// 后端地址配置</span>
    <span class="nx">server</span><span class="o">:</span> <span class="p">[</span>                      <span class="c1">// 可以配置多个后端地址</span>
        <span class="p">{</span>
            <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;api.map.baidu.com&#39;</span><span class="p">,</span>
            <span class="nx">port</span><span class="o">:</span> <span class="mi">80</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>详细配置语法可以参考  <a href="https://github.com/fex-team/node-ral">node-ral</a> 文档。</p>

<h3 id="yog-ral">yog.ral</h3>

<p><code>yog.ral</code> 是在 yog2 框架下后端服务管理层暴露的接口，在 yog2 中，我们无需关心任何初始化工作，只要添加了后端服务相应的配置，就可以使用这个接口进行服务的调用。</p>

<p>比如使用上述的百度地图API，我们可以建立一个 LBS 数据模型，专门用于地图数据的查询。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// models/lbs.js</span>

<span class="nx">module</span><span class="p">.</span><span class="kr">export</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">region</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">yog</span><span class="p">.</span><span class="nx">ral</span><span class="p">(</span><span class="s1">&#39;MAPAPI&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">region</span><span class="o">:</span> <span class="nx">region</span><span class="p">,</span>
            <span class="nx">query</span><span class="o">:</span> <span class="nx">name</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>如果不喜欢以事件的形式处理异常和数据，你还可以通过安装插件将 <code>yog.ral</code> 接口改造为 Promise 接口。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">yog2 plugin install https://github.com/hefangshi/yog2-plugin-ral-promise
</code></pre></div>
<p>之后我们的 <code>models/lbs.js</code> 模块也相应的需要调整为</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// models/lbs.js</span>

<span class="nx">module</span><span class="p">.</span><span class="kr">export</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">region</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">yog</span><span class="p">.</span><span class="nx">ral</span><span class="p">(</span><span class="s1">&#39;MAPAPI&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">region</span><span class="o">:</span> <span class="nx">region</span><span class="p">,</span>
            <span class="nx">query</span><span class="o">:</span> <span class="nx">name</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>当然，实际上如果我们希望整站都使用 Promise 风格的接口，我们可以将这段代码实现的更加简洁。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// models/lbs.js</span>

<span class="nx">module</span><span class="p">.</span><span class="kr">export</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">region</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">yog</span><span class="p">.</span><span class="nx">ral</span><span class="p">(</span><span class="s1">&#39;MAPAPI&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">region</span><span class="o">:</span> <span class="nx">region</span><span class="p">,</span>
            <span class="nx">query</span><span class="o">:</span> <span class="nx">name</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>在控制器中使用的时候，我们编写起来也会更加优雅</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">lbsModel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/lbs.js&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lbsModel</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
      <blockquote>
        <p>文章有错误？直接提交修改 <a target="_blank" href="https://github.com/fex-team/yog2/edit/gh-pages/docs/features/service.md">docs/features/service.md</a></p>
      </blockquote>
      </article>
      <!-- footer -->
<section class="footer  flush--top">
    <div class="container">
        <div class="row">
            <ul class="list-unstyled  col-12  col-sm-3  col-lg-2">
                <li><a href="oak@baidu.com">Email</a></li>
                <li><a href="https://github.com/fex-team/yog2/issues" target="_blank">Github Issue</a></li>
            </ul>
            <ul class="list-unstyled  col-12  col-sm-2  col-lg-2">
                <li><a href="/yog2/">首页</a></li>
                <li><a href="/yog2/docs">文档</a></li>
                <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
                <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
                <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
            </ul>
            <div class="col-12  col-sm-7  col-lg-5  col-lg-offset-3  text-left  hard--left">
                <h3 class="footer--main-logo">加入我们</h3> FEX 是百度「Web 前端研发部」的内部名称
                <br/> 其中 FE 是 Front End 的缩写，X 代表我们不仅关注前端技术，还更重视全端及全栈的能力。
                <br/> 如果你对这个团队感兴趣，可以 <a class="underline" target="_blank" href="http://fex.baidu.com/we-need-you/">点击这里</a>。
            </div>
        </div>
    </div>
</section>
<!-- footer -->

    </div>
    </div>

    <!-- jQuery -->
    <script src="/yog2/js/jquery.js"></script>
    <script src="/yog2/js/scrollspy.js"></script>
    <script src="/yog2/js/toc.js"></script>
    <!-- Bootstrap js -->
    <script src="/yog2/js/bootstrap.min.js"></script>
    <!-- Optionally enable responsive features in IE8. Respond.js can be obtained from https://github.com/scottjehl/Respond -->
    <script src="/yog2/js/respond.min.js"></script>

  </body>

</html>
