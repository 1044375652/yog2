<!DOCTYPE html>
<html>
    <!--head-->
    <head>
      <!-- page title goes here -->
<title>YOG2 - 工业级 Node.js UI 层解决方案</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<!-- add your name or URL here -->
<meta name="author" content="fex@baidu.com">
<!-- add a description of your site/company/product here -->
<meta name="description" content="YOG2 - 工业级 Node.js UI 层解决方案">
<!-- add the keywords here that represent your site, an example few have been added -->
<meta name="keywords" content="node, nodejs, fis, fex">
<!-- add your name or URL here -->
<meta name="publisher" content="fex">
<meta name="rating" content="General">
<!-- Bootstrap -->
<link href="/yog2/css/bootstrap.css" rel="stylesheet" media="screen">
<!-- Theme styles -->
<link href="/yog2/css/styles.css" rel="stylesheet" media="screen">
<link href="/yog2/css/animate.min.css" rel="stylesheet" media="screen">
<link href="/yog2/css/font-awesome.min.css" rel="stylesheet" media="screen">
<!-- media-queries -->
<link href="/yog2/css/media-queries.css" rel="stylesheet" media="screen">
<!-- modernizr -->
<script src="/yog2/js/modernizr.custom.js"></script>
<script src="/yog2/js/wow.min.js"></script>

      <link rel="stylesheet" href="/yog2/css/github.css">
    </head>
    <!--head-->
  <body>
    <nav class="navbar" role="navigation">
    <!-- container -->
<div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">YOG2</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse  navbar-collapse  navbar-ex1-collapse">
        <ul class="nav  navbar-nav">
            <li><a href="/yog2/">首页</a></li>
            <li><a href="/yog2/docs">文档</a></li>
            <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
            <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
            <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
        </ul>
    </div>
    <!-- /navbar-collapse -->
</div>
<!-- /container -->

    </nav>
    <div class="doc-wrap">
    <nav class="sidebar" data-spy="affix" data-offset-top="95">
    <ul>
        
        <li class="item-category">
            
            <a href="/yog2/docs/">
                快速入门
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                基础使用
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/cli.html#命令行">
                命令行
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/structure.html#目录结构">
                目录结构
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/router.html#路由">
                路由
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/basic/mvc.html#mvc">
                MVC
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                插件系统
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件系统">
                内置插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#用户插件">
                用户插件
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/plugin-system/#插件配置">
                插件配置
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                内置功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/middleware.html#中间件管理">
                中间件管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/log.html#日志管理">
                日志管理
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/features/service.html#服务管理">
                服务管理
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                前端工程化
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端工程化">
                目录规范
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#三种语言能力">
                三种语言能力
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/engineering.html#前端模块化">
                前端模块化
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/backend-template.html#后端模板">
                后端模板
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/fe/optimizer.html#性能优化">
                性能优化
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                进阶功能
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#BigPipe">
                BigPipe
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/advance/pagelet.html#Quickling">
                Quickling
            </a>
            
        </li>
        
        <li class="item-category">
            
            <span>
                其他
            </span>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/reference.html#参考资料">
                参考资料
            </a>
            
        </li>
        
        <li class="item-sub">
            
            <a href="/yog2/docs/FAQ.html#faq">
                FAQ
            </a>
            
        </li>
        
    </ul>
</nav>
<div class="bottom-shadow"></div>

    <div class="doc-container">
      <div class="toc" data-spy="affix" data-offset-top="95"></div>
      <article class="doc-content codehilite">
      <h2 id="进阶功能">进阶功能</h2>

<p>在 yog2 下，通过 widget 的划分，可以以 widget 为粒度，以多种模式加载，依靠这种技术我们可以优化大型网站性能或者轻松的实现一个单页应用。</p>

<h3 id="bigpipe">BigPipe</h3>

<p>Facebook 的 BigPipe 技术，是通过将站点分解为多个 pagelet 小块，每个pagelet 获取数据与渲染均是独立的，当传统的后端模板渲染模式受限于后端响应速度最慢的接口时，BigPipe 模式可以实现 pagelet 的数据一旦返回，就可以无阻塞的在浏览器端进行渲染，以此来实现大型复杂页面的性能加速。</p>

<p>而在 yog2 中，实际上一个 pagelet 就对应着一个 widget。我们可以通过简单的改造就实现 BigPipe 模式的加载。</p>

<p>首先，我们需要调整一下 widget 的引用写法，值得注意的是，我们并不需要调整 widget 的实现，这也意味着同一个 widget ，既可以使用传统模式加载，也可以使用 BigPipe模式加载。</p>

<p>我们通过在 <code>widget</code> 标签后添加 <code>mode=&#39;async&#39;</code> 标记指定的 <code>widget</code> 使用 BigPipe 模式加载，并且显式的为 <code>widget</code> 添加 <code>id</code> 属性方便控制器获取 <code>widget</code>。</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- /client/page/index.tpl --&gt;</span>
<span class="cp">&lt;!doctype html&gt;</span>
{% html framework=&quot;home:static/js/mod.js&quot; %}
    {% head %}
        <span class="nt">&lt;title&gt;</span>Hello World<span class="nt">&lt;/title&gt;</span>
    {% endhead %}
    {% body %}
        {% widget &quot;home:widget/search/search.tpl&quot; mode=&quot;async&quot; id=&quot;locationSearch&quot; %}
    {% endbody %}
{% endhtml %}
</code></pre></div>
<p>接着按照我们前文所说，如果使用 BigPipe 模式加载 widget ，widget 需要拥有独立的数据获取方式。那么我们就需要在控制器中通过 <code>res.bigpipe.bind</code> 函数为 <code>locationSearch</code> 这个组件绑定其独立的数据获取方式。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">lbsModel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../models/lbs.js&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">bigpipe</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;locationSearch&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lbsModel</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">region</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cb</span> <span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;home/page/index.tpl&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>在经过 BigPipe改造后，再次请求时，查看源代码我们就会发现原先 <code>locationSearch</code> 组件是以 HTML 的形式返回的，而在 BigPipe 模式下，则是从脚本中通过 <code>onPageletArrive</code> 函数返回。如果使用 fiddler 等抓包工具查看的话，还可以发现页面框架是在第一时间返回，而 <code>locationSearch</code> 的内容则是在后端请求响应后以 chunk 的形式输出至页面。</p>

<p>关于 BigPipe 的更多原理介绍，可以参考 <a href="http://velocity.oreilly.com.cn/2010/index.php?func=session&amp;name=Facebook%E7%BD%91%E7%AB%99%E7%9A%84Ajax%E5%8C%96%E3%80%81%E7%BC%93%E5%AD%98%E5%92%8C%E6%B5%81%E6%B0%B4%E7%BA%BF">Facebook网站的Ajax化、缓存和流水线</a></p>

<blockquote>
<p>需要注意的是并不是所有场景都适合使用BigPipe，只有当一个页面需要向多个系统请求数据，并且后端系统无法提供一致的返回时间保证时，使用BigPipe才会有较大的性能提升。</p>
</blockquote>

<h3 id="quickling">Quickling</h3>

<p>除了 BigPipe 模式外，我们还可以将 pagelet 用于 Quickling 模式。所谓 Quickling 模式是将 widget 整体通过 Ajax 请求返回。也就是将传统的 Ajax 请求数据，前端模板渲染数据的模式变化为 Ajax 请求渲染好的页面以及 widget 执行的必要代码和样式。这两种方式并非互相取代的关系，而是应该根据使用场景灵活判断。</p>

<p>要使用 Quickling 技术，需要比使用 BigPipe 多引用一个脚本，<a href="https://github.com/fex-team/yog2-app-template/blob/master/client/static/js/bigpipe.js">bigpipe.js</a></p>

<p>这个脚本的功能就是在前端发起一个 widget 的 Quickling 请求。</p>

<p>首先我们需要将页面中 widget 的加载模式由 <code>async</code> 调整为 <code>quickling</code></p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- /client/page/index.tpl --&gt;</span>
<span class="cp">&lt;!doctype html&gt;</span>
{% html framework=&quot;home:static/js/mod.js&quot; %}
    {% head %}
        <span class="nt">&lt;title&gt;</span>Hello World<span class="nt">&lt;/title&gt;</span>
        {% require &quot;home:static/js/bigpipe.js %}
    {% endhead %}
    {% body %}
        {% widget &quot;home:widget/search/search.tpl&quot; mode=&quot;quickling&quot; id=&quot;locationSearch&quot; %}
    {% endbody %}
{% endhtml %}
</code></pre></div>
<p>这样修改后，页面首次加载时并不会加载 <code>locationSearch</code> ，需要前端代码中通过调用 bigpipe.js 加载。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">BigPipe</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;locationSearch&#39;</span><span class="p">);</span>
</code></pre></div>
<p>更多 BigPipe 的接口可以查看 <a href="https://github.com/fex-team/yog2-app-template/tree/master/client/static/js">文档</a></p>

      <blockquote>
        <p>文章有错误？直接提交修改 <a target="_blank" href="https://github.com/fex-team/yog2/edit/gh-pages/docs/advance/pagelet.md">docs/advance/pagelet.md</a></p>
      </blockquote>
      </article>
      <!-- footer -->
<section class="footer  flush--top">
    <div class="container">
        <div class="row">
            <ul class="list-unstyled  col-12  col-sm-3  col-lg-2">
                <li><a href="oak@baidu.com">Email</a></li>
                <li><a href="https://github.com/fex-team/yog2/issues" target="_blank">Github Issue</a></li>
            </ul>
            <ul class="list-unstyled  col-12  col-sm-2  col-lg-2">
                <li><a href="/yog2/">首页</a></li>
                <li><a href="/yog2/docs">文档</a></li>
                <li><a href="https://github.com/fex-team/yog2" target="_blank">Github</a></li>
                <li><a href="http://fis.baidu.com" target="_blank">FIS</a></li>
                <li><a href="http://fex.baidu.com" target="_blank">FEX</a></li>
            </ul>
            <div class="col-12  col-sm-7  col-lg-5  col-lg-offset-3  text-left  hard--left">
                <h3 class="footer--main-logo">加入我们</h3> FEX 是百度「Web 前端研发部」的内部名称
                <br/> 其中 FE 是 Front End 的缩写，X 代表我们不仅关注前端技术，还更重视全端及全栈的能力。
                <br/> 如果你对这个团队感兴趣，可以 <a class="underline" target="_blank" href="http://fex.baidu.com/we-need-you/">点击这里</a>。
            </div>
        </div>
    </div>
</section>
<!-- footer -->

    </div>
    </div>

    <!-- jQuery -->
    <script src="/yog2/js/jquery.js"></script>
    <script src="/yog2/js/scrollspy.js"></script>
    <script src="/yog2/js/toc.js"></script>
    <!-- Bootstrap js -->
    <script src="/yog2/js/bootstrap.min.js"></script>
    <!-- Optionally enable responsive features in IE8. Respond.js can be obtained from https://github.com/scottjehl/Respond -->
    <script src="/yog2/js/respond.min.js"></script>

  </body>

</html>
